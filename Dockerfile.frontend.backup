# =============================================================================
# Dockerfile.frontend - SOLUCIÓN PROFESIONAL Y ROBUSTA
# Next.js + pnpm con optimización de caché y resiliencia de red
# =============================================================================

# -----------------------------------------------------------------------------
# ETAPA 1: Base - Configuración común
# -----------------------------------------------------------------------------
FROM node:20.11-alpine AS base

# Instalar dependencias del sistema necesarias para native modules
RUN apk add --no-cache libc6-compat python3 make g++

# Configurar pnpm usando corepack (lee la versión de package.json > packageManager)
ENV PNPM_HOME=/pnpm
ENV PATH=$PNPM_HOME:$PATH
RUN corepack enable

# -----------------------------------------------------------------------------
# ETAPA 2: Dependencies - Instalación optimizada con caché
# -----------------------------------------------------------------------------
FROM base AS dependencies
WORKDIR /app

# Copiar SOLO los manifiestos de dependencias primero (optimización de caché)
# Esto permite que Docker reutilice la capa de node_modules si el código cambia
COPY frontend/package.json ./

# Activar la versión de pnpm especificada en package.json
RUN corepack install

# Verificar si existe lockfile y copiarlo solo si está presente
COPY frontend/pnpm-lock.yaml* ./

# Configuración de red robusta para entornos corporativos/lentos
ENV CI=true
ENV NODE_OPTIONS="--max-old-space-size=4096"
ENV PNPM_NETWORK_TIMEOUT=120000
ENV PNPM_FETCH_RETRIES=5
ENV PNPM_FETCH_RETRY_MINTIMEOUT=10000
ENV PNPM_FETCH_RETRY_MAXTIMEOUT=60000

# Instalar dependencias con caché de montaje BuildKit
# --mount=type=cache: cachea el store de pnpm entre builds
# Si existe lockfile compatible, usar --frozen-lockfile, sino instalar normal
RUN --mount=type=cache,id=pnpm-store,target=/pnpm/store \
    if [ -f pnpm-lock.yaml ]; then \
        echo "Lockfile encontrado, usando frozen-lockfile..." && \
        pnpm install --frozen-lockfile --prefer-offline || \
        (echo "Lockfile incompatible, regenerando..." && \
         rm pnpm-lock.yaml && \
         pnpm install --prefer-offline); \
    else \
        echo "No existe lockfile, instalando dependencias..." && \
        pnpm install --prefer-offline; \
    fi

# -----------------------------------------------------------------------------
# ETAPA 3: Builder - Compilación de la aplicación
# -----------------------------------------------------------------------------
FROM base AS builder
WORKDIR /app

# Copiar manifiestos desde la etapa de dependencies
COPY --from=dependencies /app/package.json ./
COPY --from=dependencies /app/pnpm-lock.yaml* ./

# Copiar el código fuente completo (esto invalida caché solo si cambia el código)
COPY frontend/ ./

# Configuración de build
ENV NEXT_TELEMETRY_DISABLED=1
ENV NODE_ENV=production
ENV CI=true
ENV NODE_OPTIONS="--max-old-space-size=4096"

# Instalar dependencias con caché de BuildKit (evita COPY pesado de node_modules)
# El caché persistente hace que esta instalación sea rápida
RUN --mount=type=cache,id=pnpm-store,target=/pnpm/store \
    pnpm install --frozen-lockfile --prefer-offline || \
    pnpm install --prefer-offline

# Construir la aplicación Next.js
RUN pnpm run build

# -----------------------------------------------------------------------------
# ETAPA 4: Runner - Imagen mínima de producción
# -----------------------------------------------------------------------------
FROM node:20.11-alpine AS runner
WORKDIR /app

# Instalar solo dependencias runtime necesarias
RUN apk add --no-cache dumb-init

# Crear usuario no-root con UID/GID fijos para seguridad
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nextjs

# Copiar solo los artefactos necesarios de producción
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static
COPY --from=builder --chown=nextjs:nodejs /app/public ./public

# Configuración de runtime
ENV NODE_ENV=production
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"
ENV NEXT_TELEMETRY_DISABLED=1

# Cambiar a usuario no-root
USER nextjs

EXPOSE 3000

# Healthcheck robusto con retry
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=5 \
    CMD node -e "require('http').get('http://localhost:3000/api/health', (res) => process.exit(res.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))" || exit 1

# Usar dumb-init para manejo correcto de señales (PID 1)
ENTRYPOINT ["dumb-init", "--"]

# Iniciar la aplicación (modo standalone de Next.js)
CMD ["node", "server.js"]
