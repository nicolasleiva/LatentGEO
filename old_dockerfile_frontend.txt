# ------------------------------------------------------------
# Dockerfile.frontend
# Multistage build para Next.js + pnpm
# ------------------------------------------------------------

# Etapa: builder - compila la aplicación Next.js
FROM node:20.9-slim AS builder
WORKDIR /app

# Habilitar corepack (proporciona pnpm de forma reproducible)
RUN corepack enable && corepack prepare pnpm@latest --activate

# Indicar que estamos en CI para evitar prompts interactivos durante pnpm install
ENV CI=true

# Copiar archivos de dependencias primero para aprovechar la caché de Docker
COPY frontend/package.json frontend/pnpm-lock.yaml ./

# Instalar dependencias (NO usar --production aquí; el build necesita dev deps)
RUN pnpm install --frozen-lockfile --strict-peer-dependencies=false

# Copiar el resto del código fuente después de instalar dependencias
COPY frontend/ ./

# Opcional: listar para debug (descomenta si necesitas inspeccionar la capa)
# RUN echo ">>> /app" && ls -la /app && echo ">>> /app/node_modules/next/dist/bin" && ls -la /app/node_modules/next/dist/bin || true

# Añadir node_modules/.bin al PATH (formato key=value)
ENV PATH=/app/node_modules/.bin:$PATH

# Construir la app Next.js
RUN pnpm run build

# ------------------------------------------------------------
# Etapa: runner - imagen de producción
# ------------------------------------------------------------
FROM node:20.9-slim AS runner
WORKDIR /app

# Variables de entorno para producción
ENV NODE_ENV=production
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# Crear usuario no-root y cambiar permisos
RUN addgroup --system --gid 1001 nodejs \
 && adduser --system --uid 1001 nextjs \

# Copiar solo lo necesario para Standalone (Requiere output: 'standalone' en next.config.mjs)
COPY --from=builder /app/public ./public

# Configurar permisos para la caché de Next.js
RUN mkdir .next
RUN chown nextjs:nodejs .next

# Copiar la salida standalone y los estáticos
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

ENV HOME=/app

# Cambiar a usuario no-root
USER nextjs

EXPOSE 3000

# Healthcheck simple (ajusta la URL/puerto si usas custom server)
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
  CMD ["node", "-e", "require('http').get('http://localhost:3000', (res) => process.exit(res.statusCode == 200 ? 0 : 1))"]

# Usar node server.js en lugar de pnpm start para menor consumo de memoria
CMD ["node", "server.js"]
