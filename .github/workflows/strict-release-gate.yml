name: Strict Release Gate

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"

jobs:
  preflight:
    name: Validate Smoke Inputs
    runs-on: ubuntu-latest
    steps:
      - name: Validate required vars
        env:
          SMOKE_BASE_URL: ${{ vars.SMOKE_BASE_URL }}
        run: |
          set -euo pipefail
          if [[ -z "${SMOKE_BASE_URL:-}" ]]; then
            echo "SMOKE_BASE_URL is required for strict release smoke validation."
            exit 1
          fi
          if [[ ! "${SMOKE_BASE_URL}" =~ ^https?:// ]]; then
            echo "SMOKE_BASE_URL must start with http:// or https://"
            exit 1
          fi
          echo "Strict preflight passed."

  backend-strict:
    name: Backend Strict Gate
    runs-on: ubuntu-latest
    needs: preflight
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements-dev.txt
          pip install bandit pip-audit

      - name: Backend static quality
        run: |
          python -m ruff check backend/app backend/tests
          python -m black --check backend/app backend/tests
          python -m isort --check-only backend/app backend/tests
          python -m mypy backend/app --ignore-missing-imports --show-error-codes

      - name: Backend security gates
        run: |
          python -m bandit -r backend/app -q
          python -m pip_audit -r backend/requirements.txt

      - name: Run deterministic backend suite
        run: |
          mkdir -p artifacts
          pytest -q backend/tests -m "not integration and not live" --junitxml=artifacts/backend-local-junit.xml

      - name: Assert local deterministic suite skipped count = 0
        run: |
          python - <<'PY'
          import xml.etree.ElementTree as ET

          root = ET.parse("artifacts/backend-local-junit.xml").getroot()
          total_skipped = 0
          for suite in root.iter("testsuite"):
              total_skipped += int(suite.attrib.get("skipped", "0"))

          if total_skipped > 0:
              raise SystemExit(
                  f"Deterministic local suite requires zero skipped tests, found {total_skipped}."
              )
          print("Deterministic backend skipped assertion passed (0 skipped).")
          PY

      - name: Upload backend local artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-local-artifacts
          path: |
            artifacts/backend-local-junit.xml

  backend-smoke:
    name: Backend External Smoke Gate
    runs-on: ubuntu-latest
    needs: [preflight, backend-strict]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pytest httpx

      - name: Run external smoke suite
        env:
          SMOKE_BASE_URL: ${{ vars.SMOKE_BASE_URL }}
          SMOKE_BEARER_TOKEN: ${{ secrets.SMOKE_BEARER_TOKEN }}
        run: |
          mkdir -p artifacts
          pytest -q backend/tests/test_release_smoke_external.py --junitxml=artifacts/backend-smoke-junit.xml

      - name: Upload backend smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-smoke-artifacts
          path: |
            artifacts/backend-smoke-junit.xml

  frontend-strict:
    name: Frontend Strict Gate
    runs-on: ubuntu-latest
    needs: preflight
    steps:
      - uses: actions/checkout@v4

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.6.2

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm --dir frontend install --frozen-lockfile

      - name: Frontend quality gates
        env:
          STRICT_BUILD: "1"
        run: |
          pnpm --dir frontend run check:no-legacy-api
          pnpm --dir frontend lint
          pnpm --dir frontend run format:check
          pnpm --dir frontend run type-check
          pnpm --dir frontend test:ci
          pnpm --dir frontend build

      - name: Frontend dependency audit
        run: pnpm --dir frontend audit --audit-level=high

  strict-release-ready:
    name: Strict Release Ready
    runs-on: ubuntu-latest
    needs: [backend-strict, backend-smoke, frontend-strict]
    steps:
      - name: Final status
        run: |
          echo "Strict backend local + smoke and frontend gates passed."
          echo "Release candidate is pre-production stabilized and ready for staging validation."
